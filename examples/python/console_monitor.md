# console_monitor.py – ncurses ECU monitor (EPIC Over CANbus)

## Overview
A keyboard‑driven console (ncurses) application for monitoring selected ECU variables in real time over EPIC Over CANbus. It is intended for simple devices (Raspberry Pi, Jetson, etc.) with SocketCAN.

- Read live values (float) for any variable advertised in `epic_can_bus/variables.json`.
- Choose which variables to poll and how fast to poll.
- Filter the list by name and by source (`config`, `output`, or both`).
- Remove items from the watch list without restarting.

This app is read‑only – it does not write ECU configuration or call functions.

## Requirements
- Linux with SocketCAN (e.g., `can0` at 500k).
- Python 3.8+
- The helper module `epic_can_bus/examples/python/EpicECU/__init__.py` on import path.
- Variables index at `epic_can_bus/variables.json`.

## Start
```bash
python3 epic_can_bus/examples/python/console_monitor.py --ecu 0 --iface can0 --rate 10
```
- `--ecu` ECU address 0..15 (low nibble of CAN id), default 0
- `--iface` SocketCAN interface, default `can0`
- `--rate` poll rate (Hz), default 10.0 (bounded 0.5..50.0)

## Data sources (read‑only)
- Variables come from `epic_can_bus/variables.json` generated by `epic_can_bus/gen_variables.py`.
- Values are fetched using the EPIC helper `get_variable(sock, hash, dest=ecu)`.
- CAN protocol uses per‑ECU base IDs:
  - Get request: `0x700 + ecuId`, request payload `[0..3] VarHash (int32 BE)`
  - Get response: `0x720 + ecuId`, response payload `[0..3] VarHash (int32 BE), [4..7] Value (float32 BE)`

## UI Layout
- Header (top, 2 rows): interface, ECU id, poll ON/OFF, rate, last error, help.
- Left pane (selector): filter line, list header, scrollable list with checkboxes `[ ]`/`[x]`.
- Right pane (live values): table showing name, value, updated age, and hash.

### Color/Theme
- Norton Commander‑style blue background everywhere.
- Selected row in either pane: cyan background with bold bright foreground for high contrast.
- Search input field: cyan strip (distinct from list rows).
- Boxes/borders around both panes.

## Focus & Navigation
- Focus can be in one of: search (filter), selector (channel list), or values (live values).
- Tab (forward) and Shift‑Tab (reverse) cycle focus with guards:
  - Forward (Tab): search → selector (only if the selector has items) → values (only if there are selected items) → search.
  - Reverse (Shift‑Tab): values → selector (if selector has items) → search; from search, Shift‑Tab jumps to values only if there are selected items.
  - From search, Down Arrow moves to selector only if the selector has items.
  - Focus is never moved to an empty pane (no empty selector or empty values focus).
- Arrow keys move the cursor within the focused pane.
- PageUp/PageDown move by one visible page in the focused pane.
- Home/End jump to the start/end of the list in the focused pane.
- Cursor stays centered vertically while scrolling when possible; only approaches top/bottom near list ends.

## Keyboard shortcuts
Global (outside search):
- Tab: switch focus (selector → search → values → selector)
- p: toggle polling ON/OFF
- + / -: increase/decrease poll rate (±0.5 Hz, clamped 0.5..50 Hz)
- e: set ECU id (prompts for number 0..15)
- f: cycle source filter: both → config → output → both (affects selector list)
- q: quit

Search (filter) mode:
- Allowed characters: letters, numbers, period `.`, dash `-`, underscore `_`.
- Left/Right: move the editing cursor within the text.
- Backspace: delete the character to the left of the cursor.
- Enter: keep current filter (no focus change).
- Esc: clear filter and reset the cursor to start.
- Tab: prefers moving to selector if it has items; if the selector is empty but there are items in live values, Tab moves to values; otherwise remain in search.
- Shift‑Tab: from search, moves to values only if there are selected items; otherwise remains in search.
- Down Arrow: move to selector only if the selector has items.
- Service keys (Up, PageUp, PageDown, Home, End, Insert, Delete, Function keys F1..F12) are ignored and do not insert text.
- While in search, hotkeys (p, +, −, e, f) are disabled to avoid accidental activation.

Selector pane:
- Up/Down: move cursor within list.
- PageUp/PageDown: move by a full visible page.
- Home/End: go to top/bottom of list.
- Space: toggle selection (add/remove from watch list).
- When filtering, the current selection index is clamped to the filtered list so the highlight never disappears when focus moves from search to selector.

Live values pane:
- Up/Down: move cursor within selected items.
- PageUp/PageDown: move by a full visible page.
- Home/End: go to top/bottom of selected items.
- Delete (or DEL on some terminals): remove selected item from watch list.
- r: remove selected item.
- c: clear all selected items.

## Polling model
- When polling is ON, the app requests each selected variable sequentially every cycle.
- The cycle period is determined by `1 / rate` seconds – if too many items are selected, updates will spill to the next cycle.
- On success, value is recorded with a timestamp; the age column shows how long since last update.
- Failures (e.g., no response) are surfaced as a short status message in the header.

## Value format
- Floats are displayed to 3 decimal places by default.
- Ages shown as whole seconds since last successful update.

## Error handling
- CAN socket open failure shows an error in the header and disables polling until resolved.
- Read errors/timeouts show a transient error in the header; they clear upon the next successful read.
- Missing or unreadable `variables.json` results in an empty selector list.

## Current implementation notes
- File: `epic_can_bus/examples/python/console_monitor.py`
- Uses Python `curses` for the UI and the provided EpicECU helpers for CAN I/O.
- Keeps the highlighted row centered when possible by adjusting the first visible row per frame.
- Page sizes adapt automatically to pane height.
- Search input disables global hotkeys while focused.
- Source filter setting affects only the selector list (values pane continues to display whatever is already selected).

## Performance guidance
- Practical comfort: 10–30 variables at ~5–10 Hz on a Pi‑class SBC.
- Heavy bus traffic, slow interfaces, or many selected items will reduce effective refresh rate.

## Troubleshooting
- No values: verify `can0` is up, bitrate matches, wiring/termination is correct, and ECU runs EPIC Over CANbus.
- Wrong variables: re‑generate `variables.json` via `python3 epic_can_bus/gen_variables.py` after updating firmware.
- Laggy UI: reduce poll rate and/or number of selected variables.

## Future enhancements (not implemented)
- Save/restore watch lists (profiles), CSV export on demand, sparkline mini‑graphs, multi‑ECU pages, and optional write operations for selected `config` variables.
